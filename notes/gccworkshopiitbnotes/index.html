<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         GCC Workshop IITB Notes
        
    </title><meta content="GCC Workshop IITB Notes" property=og:title><link href=https://dipeshkaphle.github.io/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[[`\$`,`\$`],[`\\\\(`,`\\\\)`]]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://dipeshkaphle.github.io/atom.xml rel=alternate title=Dipesh type=application/atom+xml><link href=https://dipeshkaphle.github.io/theme/light.css rel=stylesheet><link href=https://dipeshkaphle.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://dipeshkaphle.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme())</script><link href=https://dipeshkaphle.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://dipeshkaphle.github.io>Dipesh</a><div class=socials><a class=social href=https://twitter.com/__dipesh_ rel=me> <img alt=twitter src=https://dipeshkaphle.github.io/social_icons/twitter.svg> </a><a class=social href=https://github.com/dipeshkaphle rel=me> <img alt=github src=https://dipeshkaphle.github.io/social_icons/github.svg> </a><a class=social href=https://linkedin.com/dipeshk111 rel=me> <img alt=linkedin src=https://dipeshkaphle.github.io/social_icons/linkedin.svg> </a></div></div><nav><a href=https://dipeshkaphle.github.io/about style=margin-left:.5em>/about</a><a href=https://dipeshkaphle.github.io/posts style=margin-left:.5em>/blog</a><a href=https://dipeshkaphle.github.io/notes style=margin-left:.5em>/notes</a><a href=https://dipeshkaphle.github.io/tags style=margin-left:.5em>/tags</a><a href=https://dipeshkaphle.github.io/projects style=margin-left:.5em>/projects</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://dipeshkaphle.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://dipeshkaphle.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>GCC Workshop IITB Notes<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2023-02-27</time></div></div><section class=body><blockquote><p><strong>NOTE</strong> : This is still incomplete and I might add content as I see the videos more.</blockquote><h2 id=notes>Notes</h2><blockquote><p>Variable Meanings<ul><li>$(SOURCE_D) = Source directory<li>$(BUILD) = Build directory<li>$(INSTALL) = Install directory</ul></blockquote><blockquote><p>The workshop was held in 2012, so a lot has changed code wise but the concept is pretty much same. One major thing is, most of the code is C++ code(.cc extension) but when this workshop was happening it was all C files(.c extension).</blockquote><h2 id=configuring-gcc>Configuring GCC</h2><p><img alt src=/IITB-GCC/Configuring.png><blockquote><p>Convention followed in the picture:<ol><li>Box => Executable<li>Not in Box => File/Data'<li>Oval => Library</ol></blockquote><p>Gcc generates a lot of source code during the build step.<h3 id=terminologies>Terminologies</h3><ul><li>The sources of the compiler are compiled on <code>Build System</code>.<li>The built compiler runs on <code>Host System</code>(host).<li>The compiler compiles code for the <code>Target System</code>(target).</ul><blockquote><ul><li>More on configure terminologies found <a href=https://gcc.gnu.org/onlinedocs/gccint/Configure-Terms.html#Configure-Terms>here</a><li>All Configure Options found <a href=https://gcc.gnu.org/install/configure.html>here</a></ul></blockquote><h2 id=what-happens-during-build>What happens during build?</h2><h3 id=normal-build-steps>Normal Build Steps</h3><p><img alt src=/IITB-GCC/build_steps.png><h3 id=native-build-with-bootstrapping>Native Build With Bootstrapping</h3><p><img alt src=/IITB-GCC/native_build_bootstrap.png><h3 id=build-stages>Build Stages</h3><p><img alt src=/IITB-GCC/stage_1_build.png><ul><li>Stage 1 files created in $(BUILD)/stage1-gcc<li>Stage 2 files created in $(BUILD)/prev-gcc<li>Stage 2 files created in $(BUILD)/gcc</ul><blockquote><p>NOTE: Cross compilation is difficult and weird</blockquote><blockquote><p>There's explanation of mechanism to add new target to gcc in the workshop. But since it's unlikely you'd want to do this, I'm skipping it. It starts at 3/4th of the video L3-B.</blockquote><h2 id=directory-structure>Directory Structure</h2><h3 id=frontend-code>Frontend Code</h3><ul><li>Kept in <code>&LTsource_directory>/gcc/&LTlang></code> where <code>lang</code> can be language frontends c,cp,go,etc<li>It contains parsing code, additional ast/generic nodes,if any. It also has interface to generic creation</ul><h3 id=optimizer-code-and-backend-generator-code>Optimizer Code and Backend Generator Code</h3><ul><li>Kept in <code>&LTsource_directory>/gcc</code><li><code>&LTsource_directory>/gcc/config/&LTtarget_dir></code> has backend code. <code>&LTtarget>.md</code> and <code>&LTtarget>.h</code> files will be present. <code>&LTtarget>.cc</code> may also be there. It'll have more files than this though.</ul><h2 id=plugins>Plugins</h2><h3 id=static-plugin>Static Plugin</h3><ul><li>Changes required in gcc/Makefile.in, some header and source files.<li>Atleast cc1 may have to be rebuild and all other files that were affected by source change.</ul><h3 id=dynamic-plugin>Dynamic Plugin</h3><ul><li><p>Supported on platforms that support -ldl -rdynamic.</p><li><p>Loaded using dlopen and invoked at pre-determined locations in compilation process.</p><li><p>Command line option: -fplugin=/path/to/name.so</p><li><p>The compilers are also plugins. They are static plugins however and can be found in <code>$(SOURCE_D)/gcc/gcc.cc</code>. There's an array of them, called <code>static const struct compiler default_compilers[]</code>.</p> <blockquote><p># means default specs not availble in top level directory. Defined somewhere else. @ means Aliased entry.</blockquote><li><p><code>$(SOURCE_D)/gcc/&LTlang>/lang-specs.h</code> has more information about the compiler. Example: C++'s specs can be seen in <code>$(SOURCE_D)/gcc/cp/lang-specs.h</code> and for C, it's defined in the gcc.cc file itself(so it's @ implying it's aliased entry. For C++ it's in different directory, so it doesn't have default specs).</p><li><p>Dynamic plugin mechanism just adds a node to the linked list of optimization passes.</p><li><p>Passes are executed with <code>execute_pass_list</code> function defined in <code>$(SOURCE_D)/gcc/passes.cc</code> which is just a while loop running all the passes.</p></ul><h4 id=interprocedural-pass>Interprocedural Pass</h4><ul><li><code>simple_ipa_opt_pass</code> => Works on functions in a translation unit, stored in variable <code>all_simple_ipa_passes</code><li>Regular IPA pass => Works across translation units. Used in link time optimization. <code>ipa_opt_pass_d</code> has details about ipa passes,which will be used in lto.</ul><h4 id=predefined-pass-lists>Predefined pass lists</h4><ul><li><code>all_lowering_passes</code><li><code>all_small_ipa_passes</code><li><code>all_regular_ipa_passes</code><li><code>all_lto_gen_passes</code><li><code>all_passes</code> => Intraprocedural passes on gimple and rtl</ul><h3 id=adding-a-static-pass>Adding a static Pass</h3><p><img alt src=/IITB-GCC/add_static_pass.png><h2 id=control-flow>Control Flow</h2><h3 id=gcc-driver-program>GCC Driver Program</h3><ul><li>control flow can be found in <code>$(SOURCE_D)/gcc/gcc.cc</code> in <code>driver::main</code> function definition.</ul><h3 id=cc1-top-level-control-flow>CC1 Top Level Control Flow</h3><ul><li>can be found in toplev.cc <code>$(SOURCE_D)/gcc/toplev.cc</code> in <code>toplev::main</code> function definition.</ul><blockquote><p>NOTE: Watch L5-A if more insights needed about the flow of program. It has many more things such as code gen flow, passes flow, lowering passes flow, etc.</blockquote><blockquote><p>NOTE: Better to See L5-B by yourself as well, the LTO section is amazing. Skipping it because it's kind of an advanced topic. <strong>TODO</strong> : Make notes on this</blockquote><h2 id=generic-gimple-and-rtl>GENERIC, GIMPLE and RTL</h2><h3 id=generic>GENERIC</h3><ul><li>Language independent IR for a complete function in the form of trees<li>Obtained by removing language specific constructs from ASTs<li>All tree codes defined in <code>$(SOURCE_D)/gcc/tree.def</code><li>With this, all language can have their own ASTs and they just have to emit GENERIC and gcc will take over from there.</ul><h3 id=gimple>GIMPLE</h3><ul><li>Language indepedent 3 address code representation<li>It is simplified subset of GENERIC.<li>It has 3 address codes, simplified scope(block begin and end), Control Flow Lowering, simplified and restricted grammar<li>Easy to optimize</ul><h4 id=manipulating-gimple>Manipulating GIMPLE</h4><ul><li>A Basic Block contains a doubly linked list of GIMPLE statements<li>The statements are represented as GIMPLE tuple and the operands are represented by a tree data structure.<li>Processing of statements done through iterators.</ul><blockquote><p>Many APIs for GIMPLE manipulation can be found in <code>$(SOURCE_D)/gcc/gimple.h</code></blockquote><h4 id=manipulating-tree>Manipulating tree</h4><ul><li>My friends found a great blog post about manipulating gimple from <a href=https://github.com/Jongy>Yonatan Goldschmidt</a>. The blog post is in 2 parts. It lies <a href=https://jongy.github.io/2020/04/25/gcc-assert-introspect.html>here</a> and <a href=https://jongy.github.io/2020/05/15/gcc-assert-introspect-2.html>here</a>. The code is <a href=https://github.com/Jongy/gcc_assert_introspect>here</a> and it's a great resource for learning ast manipulation in gcc.</ul></section></article></main><hr><center><small>Copyright © Dipesh Kafle. All rights reserved. | Powered by <a href=https://getzola.org rel=nofollow>Zola</a> & <a href=https://github.com/not-matthias/apollo/ rel=nofollow>Apollo</a></small></center></div>
<!doctype html><html><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Non Local Jumps with setjmp and longjmp
        
    </title><meta content="Non Local Jumps with setjmp and longjmp" property=og:title><link href=https://dipeshkaphle.github.io/fonts.css rel=stylesheet><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://dipeshkaphle.github.io/atom.xml rel=alternate title=Dipesh type=application/atom+xml><link href=https://dipeshkaphle.github.io/theme/light.css rel=stylesheet><link href=https://dipeshkaphle.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://dipeshkaphle.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://dipeshkaphle.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://dipeshkaphle.github.io>Dipesh</a><div class=socials><a class=social href=https://twitter.com/__dipesh_ rel=me> <img alt=twitter src=https://dipeshkaphle.github.io/social_icons/twitter.svg> </a><a class=social href=https://github.com/dipeshkaphle rel=me> <img alt=github src=https://dipeshkaphle.github.io/social_icons/github.svg> </a><a class=social href=https://linkedin.com/dipeshk111 rel=me> <img alt=linkedin src=https://dipeshkaphle.github.io/social_icons/linkedin.svg> </a></div></div><nav><a href=https://dipeshkaphle.github.io/about style=margin-left:.5em>/about</a><a href=https://dipeshkaphle.github.io/posts style=margin-left:.5em>/blog</a><a href=https://dipeshkaphle.github.io/notes style=margin-left:.5em>/notes</a><a href=https://dipeshkaphle.github.io/projects style=margin-left:.5em>/projects</a><a href=https://dipeshkaphle.github.io/pubs style=margin-left:.5em>/publications</a><a href=https://dipeshkaphle.github.io/tags style=margin-left:.5em>/tags</a><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://dipeshkaphle.github.io/feather/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://dipeshkaphle.github.io/feather/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>Non Local Jumps with setjmp and longjmp<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2023-11-01</time><span class=tags-label> :: Tags:</span><span class=tags> <a class=post-tag href=https://dipeshkaphle.github.io/tags/c/>C</a>, <a class=post-tag href=https://dipeshkaphle.github.io/tags/low-level/>Low-Level</a> </span></div></div><section class=body><p>While going through Postgres source code, I found a really cool way technique they were using to do non local jumps(acting sort of as an exception handling mechanism). Postgres is written in C and C doesn't really have a construct for exceptions, so how would they do something like this?<p>One very common functionality we observe in any interactive shell is when we press <code>Ctrl-c</code>, that operation gets cancelled. You can take python repl as an example. When I pressed <code>Ctrl-c</code> it aborted and printed <code>KeyboardInterrupt</code>.<pre class=giallo style=color:#f8f8f2;background-color:#272822><code data-lang=shellscript><span class=giallo-l><span style=color:#a6e22e>λ</span><span style=color:#e6db74> python</span></span>
<span class=giallo-l><span style=color:#a6e22e>Python</span><span style=color:#ae81ff> 3.11.5</span><span> (main,</span><span style=color:#e6db74> Sep</span><span style=color:#ae81ff>  2</span><span style=color:#e6db74> 2023, 14:16:33</span><span>) [GCC </span><span style=color:#ae81ff>13.2.1</span><span> 20230801] on linux</span></span>
<span class=giallo-l><span style=color:#a6e22e>Type</span><span style=color:#e6db74> "help", "copyright", "credits" or "license" for more information.</span></span>
<span class=giallo-l><span>>>></span><span style=color:#66d9ef> print</span><span>(</span></span>
<span class=giallo-l><span style=color:#a6e22e>KeyboardInterrupt</span></span>
<span class=giallo-l><span>>>></span></span></code></pre><p>Postgres also offers a similar interactive environment in the form of <code>psql</code> binary which lets us run db operations interactively. They also obviously offer similar functionality of aborting when you press <code>Ctrl-c</code>.<p>To understand how this functionality would be implemented, we need to know a few things. When we press <code>Ctrl-c</code>, we are sending something called an interrupt. That interrupt is handled by the kernel by sending a signal to the running process(<a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#references-1>1</a>). Our <code>Ctrl-c</code> keypress will trigger a <code>SIGINT</code> signal. And we have mechanism to handle signals(<a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#references-2>2</a>) ourselves in user code. Using that, we can use that to do a lot of powerful things.<p>Let's take a look into the postgres(<code>psql</code> to be specific) code to figure out how they do this.<p>The directory for <code>psql</code> code lies at <code>src/bin/psql</code>. The entrypoint(main function) is inside <code>startup.c</code>, which internally calls <code>MainLoop</code> function in <code>mainloop.c</code>(aptly named).<ul><li>In <code>startup.c</code>, there's a call to <code>psql_setup_cancel_handler</code>(which is a oneliner <code>setup_cancel_handler(psql_cancel_callback)</code>) which eventually ends up calling <code>setup_cancel_handler()</code> in <code>src/fe_utils/cancel.c</code>(there signal handler for SIGINT is registered, and also a callback function is registered). The <code>handle_sigint</code> function is registered for handling <code>SIGINT</code>, inside which it calls <code>cancel_callback</code> function if it's not NULL(which it won't be for our particular codepath).</ul><p><a id=setup_cancel_handler> </a> <img alt=setup_cancel_handler src=/nonlocaljumps/setup_cancel_handler.png> <a id=handle_sigint> </a> <img alt=handle_sigint src=/nonlocaljumps/handle_sigint.png><p><a id=signal_conclusion></a> So, basically <code>psql_cancel_callback</code> function is run as part of the signal handler (<code>handle_sigint</code>).<ul><li>Now, let's look at the main loop. The <code>MainLoop</code> function does a bunch of stuff at the start(which I have no clue about) but the actual loop is mainly the following code. It's a huge function which does a lot of things(expected since it's what drives the whole program). If you scroll through it you'll find that it's getting line and executing it(handling exits,clearing,etc. too), it's quite involved really.</ul><p>I came across this particular code snippet(where I have my cursor in the screenshot). I had heard about something called <code>setjmp/longjmp</code> before but hadn't really encountered them in real world code(Could be that I haven't seen a lot of real world code).<p><a id=sigsetjmp></a> <img alt=MainLoop src=/nonlocaljumps/main_loop.png><h2 id=short-primer-on-non-local-jump-construct-in-c>Short primer on non local jump construct in C</h2><ul><li><code>setjmp</code> : Marks the point where this was called as somewhat of a checkpoint by saving the execution state<li><code>longjmp</code>: We jump to the checkpoint from wherever we are. This can be across functions (of course locally too).</ul><p>An example (taken straight from <a href=https://en.wikipedia.org/wiki/Setjmp.h rel=external>Wikipedia</a>) will make it a bit more clearer. The wikipedia page does a great job of showing how it can be used.<pre class=giallo style=color:#f8f8f2;background-color:#272822><code data-lang=c><span class=giallo-l><span style=color:#f92672>#include</span><span style=color:#e6db74> &lt;stdio.h></span></span>
<span class=giallo-l><span style=color:#f92672>#include</span><span style=color:#e6db74> &lt;setjmp.h></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f92672>static</span><span> jmp_buf buf;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#66d9ef;font-style:italic>void</span><span style=color:#a6e22e> second</span><span>() {</span></span>
<span class=giallo-l><span style=color:#a6e22e>    printf</span><span>(</span><span style=color:#e6db74>"second</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>"</span><span>);</span><span style=color:#88846f>         // prints</span></span>
<span class=giallo-l><span style=color:#a6e22e>    longjmp</span><span>(buf,</span><span style=color:#ae81ff>1</span><span>);</span><span style=color:#88846f>             // jumps back to where setjmp was called - making setjmp now return 1</span></span>
<span class=giallo-l><span>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#66d9ef;font-style:italic>void</span><span style=color:#a6e22e> first</span><span>() {</span></span>
<span class=giallo-l><span style=color:#a6e22e>    second</span><span>();</span></span>
<span class=giallo-l><span style=color:#a6e22e>    printf</span><span>(</span><span style=color:#e6db74>"first</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>"</span><span>);</span><span style=color:#88846f>          // does not print</span></span>
<span class=giallo-l><span>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#66d9ef;font-style:italic>int</span><span style=color:#a6e22e> main</span><span>() {</span></span>
<span class=giallo-l><span style=color:#f92672>    if</span><span> (</span><span style=color:#f92672>!</span><span style=color:#a6e22e>setjmp</span><span>(buf))</span></span>
<span class=giallo-l><span style=color:#a6e22e>        first</span><span>();</span><span style=color:#88846f>                // when executed, setjmp returned 0</span></span>
<span class=giallo-l><span style=color:#f92672>    else</span><span style=color:#88846f>                        // when longjmp jumps back, setjmp returns 1</span></span>
<span class=giallo-l><span style=color:#a6e22e>        printf</span><span>(</span><span style=color:#e6db74>"main</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>"</span><span>);</span><span style=color:#88846f>       // prints</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#f92672>    return</span><span style=color:#ae81ff> 0</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>Postgres doesn't use <code>setjmp/longjmp</code> but uses <code>sigsetjmp/siglongjmp</code> because they're supposed to be used if you're using them in signal handling context it seems(again a piece of knowledge from the linked wikipedia page).<blockquote><p>Something fun to do: Look into if <code>setjmp/longjmp</code> allow us to implement delimited continuations(TODO: I need to understand them better)</blockquote><h2 id=tying-together-all-the-pieces>Tying together all the pieces</h2><p>We saw the <code>sigsetjmp</code> call to establish a checkpoint(<a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#sigsetjmp>here</a>). Now we need to find where <code>siglongjmp</code> call is coming from. Well, that's easy, it's probably coming somewhere from the signal handler.<p>Seeing <a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#setup_cancel_handler>setup_cancel_handler</a>, we see a callback function(i.e <code>query_cancel_callback</code>, which is basically <code>psql_cancel_callback</code>) being assigned to <code>cancel_callback</code> variable and that is called in the <a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#handle_sigint>handle_sigint</a> function. I had already mentioned this <a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#signal_conclusion>before</a>).<p><a id=psql_cancel_callback></a> <img alt=psql_cancel_callback src=/nonlocaljumps/psql_cancel_callback.png><p>Voila, We see the <code>siglongjmp</code> call here.<p>So, all of the stuff above is responsible for this small functionality.<p><img alt="Interruption handler" src=/nonlocaljumps/interruption_before.png><h2 id=verifying-what-i-figured-out-above-isn-t-a-load-of-crap>Verifying what I figured out above isn't a load of crap</h2><p>Let's make change to <a href=https://dipeshkaphle.github.io/posts/nonlocaljumps/#psql_cancel_callback>psql_cancel_callback</a> and add a new print statement.<p><img alt=printing_callback src=/nonlocaljumps/printing_cancel_callback.png><p>And let's also add a print after <code>sigsetjmp</code> in <code>MainLoop</code><p><img alt=printing_mainloop src=/nonlocaljumps/printing_mainloop.png><p>After I compile with these changes, the behaviour of <code>Ctrl-c</code> changes slightly in <code>psql</code>. Now I get this<p><img alt="After modification" src=/nonlocaljumps/interruption_after.png><p>So, I guess it wasn't incorrect.<h2 id=references>References</h2><ol><li><a id=references-1></a> <a href=https://stackoverflow.com/questions/13341870/signals-and-interrupts-a-comparison rel=external>Signals and Interrupts</a><li><a id=references-2></a> <a href=https://beej.us/guide/bgc/html/split/signal-handling.html rel=external>Signal Handling</a><li><a id=set-jmp></a> <a href=https://en.wikipedia.org/wiki/Setjmp.h rel=external>Setjmp Wikipedia</a></ol></section></article></main><hr><center><small>Copyright © Dipesh Kafle. All rights reserved. | Powered by <a href=https://getzola.org rel=nofollow>Zola</a> & <a href=https://github.com/not-matthias/apollo/ rel=nofollow>Apollo</a></small></center></div>